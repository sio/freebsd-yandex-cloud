name: ci/build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '33 13 15 * *'

jobs:
  packer:
    name: freebsd-${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version:
          - 13.2-STABLE
    steps:
      - uses: actions/checkout@v3

      - name: install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libguestfs-tools \
            qemu-kvm
          wget "$PACKER_URL" -O /tmp/packer.zip
          cd /usr/local/bin
          unzip -v /tmp/packer.zip
          packer --version
        env:
          PACKER_URL: https://releases.hashicorp.com/packer/1.8.6/packer_1.8.6_linux_amd64.zip

      - name: build image
        run: |
          sudo chmod a+rw /dev/kvm
          make build VERSION=${{ matrix.version }}
